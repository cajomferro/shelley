name: AquamoteCore
start_with: [wake_up_manual]
end_with: [sleep]
components:
    c: Controller
operations:
    wake_up_manual:
      next: [start_http, start_http_err]
      micro: c.wakeup
    wake_up_timeout:
      next: [start_http, start_http_err]
      micro: c.sleep_timeout
    start_http:
        next: [hello]
        micro: c.radio_init
    start_http_err:
        next: [start_http, start_http_err, follow_plan]
        micro: c.radio_err
    hello:
        next: [handle_request]
        micro: [c.server_connect]
    handle_request:
        next:  [handle_request, stop_http]
        micro:
          xor:
            - c.send_ok
            - c.send_err
    stop_http:
        next: [follow_plan, start_http]
        micro: [c.server_disconnect, c.radio_stop]
    follow_plan:
        next: [sleep]
        micro: [c.run_valves]
    sleep:
        next: [wake_up_manual, wake_up_timeout]
        micro: [c.sleep]
#
#test_system:
#  ok:
#    valid1: [wakeup, start_http, send_ok, disconnect, connect_stop, runValves, sleep]
#    valid2x: [wakeup, start_http, send_ok, disconnect, connect_stop, runValves, sleep, sleepTimeout, start_http, send_ok, disconnect, connect_stop, runValves, sleep]
#    reconnect: [wakeup, start_http, send_ok, disconnect, reconnect, disconnect, connect_stop, runValves, sleep]
#    reconnect2: [wakeup, start_http, send_ok, disconnect, reconnect, send_ok, disconnect, connect_stop, runValves, sleep]
#    send2x: [wakeup, start_http, send_ok, send_ok, disconnect, connect_stop, runValves, sleep]
#    send3x: [wakeup, start_http, send_ok, send_err, send_ok, disconnect, connect_stop, runValves, sleep]
#    4evererror: [wakeup, start_http, send_err, send_err, send_err, send_err, send_err, disconnect, connect_stop, sleep]
#  fail:
#    valid1_err1: [wakeup, connect_begin_err, send_ok, disconnect, connect_stop, runValves, sleep] # connect_begin_err instead of start_http
#    valid1_err2: [wakeup, start_http, send_ok, disconnect, runValves, sleep] # missing connect_stop
#    reconnect: [wakeup, start_http, send_ok, disconnect, reconnect, runValves, sleep]
#
#test_integration:
#  ok:
#    valid1: [m.locked, m.unlocked, lp.cancel, r.begin, r.send, r.send_ok, r.disconnect, r.stop, v.v1, v.v2, v.v3, v.v4, lp.setup, lp.sleep]
#    valid2: [m.locked, m.unlocked, lp.cancel, r.begin, r.send, r.send_ok, r.disconnect, r.stop, v.v1, v.v2, v.v3, v.v4, lp.setup, lp.sleep, m.locked, m.unlocked, lp.cancel, r.begin, r.send, r.send_ok, r.disconnect, r.stop, v.v1, v.v2, v.v3, v.v4, lp.setup, lp.sleep]
#  fail:
#    invalid1a: [m.locked, m.unlocked, lp.cancel, r.begin, r.send, r.disconnect, r.stop, v.v1, v.v2, v.v3, v.v4, lp.setup, lp.sleep, lp.wakeup] # missing r.send_ok on macro behavior send
#    invalid1b: [m.locked, m.unlocked, r.begin, r.send, r.send_ok, r.disconnect, r.stop, v.v1, v.v2, v.v3, v.v4, lp.setup, lp.sleep, lp.wakeup] # missing 'lp.cancel' on macro behavior 'wakeup'
#    invalid1c: [m.locked, lp.cancel, r.begin, r.send, r.send_ok, r.disconnect, r.stop, v.v1, v.v2, v.v3, v.v4, lp.setup, lp.sleep, lp.wakeup] # missing 'm.unlocked' on macro behavior 'wakeup'
#    invalid1d: [m.locked, m.unlocked, lp.cancel, r.begin, r.send, r.send_ok, r.disconnect, r.stop, v.v1, v.v2, v.v3, v.v4, lp.setup, lp.sleep, lp.wakeup] # wakeup is not final
#    invalid2a: [m.locked, m.unlocked, lp.cancel, r.begin, r.send, r.disconnect, r.stop, v.v1, v.v2, v.v3, v.v4, lp.sleep, m.locked, m.unlocked, lp.cancel] # missing r.send_ok on macro behavior send
#    invalid2b: [m.locked, m.unlocked, r.begin, r.send, r.send_ok, r.disconnect, r.stop, v.v1, v.v2, v.v3, v.v4, lp.sleep, m.locked, m.unlocked, lp.cancel] # missing 'lp.cancel' on macro behavior 'wakeup'
#    invalid3: [m.locked, m.unlocked]
#    invalid4: [m.locked, m.unlocked, lp.cancel, r.begin, r.send, r.send_ok, r.disconnect, r.stop, v.v1, v.v2, v.v3, v.v4]
#    invalid5: [m.locked, m.unlocked, lp.cancel]
#    invalid7: false
#    empty: []