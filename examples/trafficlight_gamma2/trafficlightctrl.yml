# Since we don't have any state information, we need explicit events for changing from normal to
# interrupt and vice-versa. Otherwise we could have wrong traces like changing from normal_green
# to interrupted_blinkingyellow [macro] fired by a BlinkingYellowTimeout3 event [micro].

name: TrafficLightCtrl
start_with: [normal_entry0]
end_with: $ANY
components:
  PoliceInterrupt : PoliceInterrupt # input
  Control: Control # input
  BlinkingYellowTimeout3: Timer
  BlackTimeout4: Timer
  LightCommands: LightCommands # output
operations:
  normal_entry0:
      next: [interrupted_entry1, normal_green]
      micro: LightCommands.displayRed
  normal_entry2:
      next: [interrupted_entry1, normal_green]
      micro:
        seq: [PoliceInterrupt.off, LightCommands.displayRed]
  normal_red:
      next: [normal_green, interrupted_entry1]
      micro:
        seq: [Control.toggle, LightCommands.displayRed]
  normal_green:
      next: [normal_yellow, interrupted_entry1]
      micro: [Control.toggle, LightCommands.displayGreen]
  normal_yellow:
      next: [normal_red, interrupted_entry1]
      micro: [Control.toggle, LightCommands.displayYellow]
  interrupted_entry1:
      next: [interrupted_black, normal_entry2]
      micro:
        seq: [PoliceInterrupt.on, LightCommands.displayYellow]
  interrupted_blinkingyellow:
      next: [normal_entry2, interrupted_black]
      micro:
        seq: [BlackTimeout4.timeout, LightCommands.displayYellow]
  interrupted_black:
      next: [normal_entry2, interrupted_blinkingyellow]
      micro:
        seq: [BlinkingYellowTimeout3.timeout, LightCommands.displayNone]

#  behavior:
#    # normal
#    - [normal_entry0, normal_green]
#    - [normal_red, normal_green]
#    - [normal_green, normal_yellow]
#    - [normal_yellow, normal_red]
#    # normal -> interrupted
#    - [normal_entry0, interrupted_entry1]
#    - [normal_entry2, interrupted_entry1]
#    - [normal_red, interrupted_entry1]
#    - [normal_green, interrupted_entry1]
#    - [normal_yellow, interrupted_entry1]
#    - [interrupted_entry1, interrupted_black]
#    # interrupted -> normal
#    - [interrupted_blinkingyellow, normal_entry2]
#    - [interrupted_black, normal_entry2]
#    - [interrupted_entry1, normal_entry2]
#    - [normal_entry2, normal_green]
#    # interrupted
#    - [interrupted_blinkingyellow, interrupted_black]
#    - [interrupted_black, interrupted_blinkingyellow]