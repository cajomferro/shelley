name: Controller
start_with: [start]
end_with: $ANY
components:
    v: ValveHandlerTimer
    m: Magnetic
    rs: RadioV3
    lp: LowPowerStrict
operations:
    start:
        next: [update]
        micro: [m.locked, m.unlocked, lp.cancel]
    wakeup:
        next: [update]
        micro: [lp.wakeup]
    update:
        next: [runValves]
        micro: [rs.send, rs.ok]
    runValves:
        next: [sleep]
        micro: [v.v1, v.v2, v.v3, v.v4]
    sleep:
        next: [start, wakeup]
        micro: [lp.setup, lp.sleep]

test_integration:
  ok:
    valid1: [m.locked, m.unlocked, lp.cancel, rs.send, rs.ok, v.v1, v.v2, v.v3, v.v4, lp.setup, lp.sleep, lp.wakeup]
    valid2: [m.locked, m.unlocked, lp.cancel, rs.send, rs.ok, v.v1, v.v2, v.v3, v.v4, lp.setup, lp.sleep, m.locked, m.unlocked, lp.cancel]
    valid3: [m.locked, m.unlocked, lp.cancel, rs.send, rs.ok, v.v1, v.v2, v.v3, v.v4]
    valid4: [m.locked, m.unlocked, lp.cancel]
  fail:
    invalid1a: [m.locked, m.unlocked, lp.cancel, rs.send, v.v1, v.v2, v.v3, v.v4, lp.setup, lp.sleep, lp.wakeup] # missing rs.ok on macro behavior update
    invalid1b: [m.locked, m.unlocked, rs.send, rs.ok, v.v1, v.v2, v.v3, v.v4, lp.setup, lp.sleep, lp.wakeup] # missing 'lp.cancel' on macro behavior 'start'
    invalid1c: [m.locked, lp.cancel, rs.send, rs.ok, v.v1, v.v2, v.v3, v.v4, lp.setup, lp.sleep, lp.wakeup] # missing 'm.unlocked' on macro behavior 'start'
    invalid2a: [m.locked, m.unlocked, lp.cancel, rs.send, v.v1, v.v2, v.v3, v.v4, lp.sleep, m.locked, m.unlocked, lp.cancel] # missing rs.ok on macro behavior update
    invalid2b: [m.locked, m.unlocked, rs.send, rs.ok, v.v1, v.v2, v.v3, v.v4, lp.sleep, m.locked, m.unlocked, lp.cancel] # missing 'lp.cancel' on macro behavior 'start'
    invalid6: [m.locked, m.unlocked]
    invalid7: false
    empty: []